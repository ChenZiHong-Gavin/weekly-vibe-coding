### 项目概述

创建一个基于浏览器的手势交互音游，模仿任天堂游戏《太鼓达人》的核心玩法，通过MediaPipe实现空手"击鼓"体验。用户可通过摄像头识别手势，在空气中模拟敲鼓动作来演奏音乐。

---

### 核心功能需求

### 1. **音频处理模块**

- 输入：支持上传音频文件（MP3/WAV）
- 谱面生成：
    - 使用音频分析库（如Web Audio API、Aubrey.js）自动检测节拍点（BPM）和鼓点
    - 自动生成红、蓝两种音符（根据节拍强度或频率分布）
    - 支持难度选择（Easy/Normal/Hard），影响音符密度和速度
    - 提供可视化谱面编辑器，允许手动调整音符位置
- 音游数据格式：生成可保存的JSON谱面文件，包含时间戳、音符类型、位置信息

### 2. **手势识别与交互模块**

- 使用**MediaPipe Hands**实时检测双手21个关键点
- 定义明确的"击鼓"手势：
    - **红鼓（Don）**：右手握拳向前快速移动（检测手腕加速度+wrist位置变化）
    - **蓝鼓（Kat）**：左手张开向前快速移动（检测手指伸展状态+手腕加速度）
    - 设置判定区域：在屏幕下方定义两个虚拟鼓面区域
- 性能优化：
    - 设置检测置信度阈值（≥0.7）
    - 实现手势平滑算法，减少抖动误判

### 3. **游戏核心机制**

- **判定系统**：
    - 完美（Perfect）：±30ms时间窗口
    - 良好（Good）：±60ms时间窗口
    - 错过（Miss）：超过±60ms
- **计分系统**：
    - 基础分数计算：Perfect=1000分，Good=500分
    - 连击加成：连续Perfect时，分数×(1+连击数×0.1)
    - 准确率显示：实时显示Perfect/Good/Miss统计
- **视觉反馈**：
    - 击鼓时显示鼓面动画和冲击波效果
    - 判定文字在击打位置弹出（Perfect金色，Good蓝色）
    - 连击数在屏幕中央高亮显示
    - 背景根据连击数动态变化

### 4. **UI/UX设计**

- **界面布局**：
    - 顶部：歌曲信息、分数、连击数、准确率
    - 中央：游戏主区域（鼓面、判定线、音符下落轨道）
    - 底部：实时手势识别预览窗口（可折叠）
- **游戏流程**：
    1. 歌曲选择/上传界面
    2. 难度选择与谱面预览
    3. 校准阶段：调整摄像头延迟补偿（可选）
    4. 倒计时3,2,1,Go!
    5. 游戏进行中
    6. 结果页面：总分、评级（S/A/B/C/D）、重玩/分享选项
- **响应式设计**：支持桌面和移动设备（需前置摄像头）

---

### 技术实现要求

### 前端技术栈

- **框架**：原生JavaScript/TypeScript + React（可选）
- **手势识别**：@mediapipe/hands + Handsfree.js（封装库）
- **音频处理**：Web Audio API、Aubrey.js（节拍检测）
- **动画**：Canvas API 或 PIXI.js（复杂动画）
- **状态管理**：Redux/Zustand（如使用React）

### 代码结构

```jsx
// 建议的模块化结构
src/
├── core/
│   ├── AudioAnalyzer.js      // 音频分析与谱面生成
│   ├── GameEngine.js         // 游戏主循环与判定逻辑
│   └── GestureDetector.js    // MediaPipe手势封装
├── components/
│   ├── GameCanvas.jsx        // 游戏渲染组件
│   ├── HandPreview.jsx       // 手势预览组件
│   └── UI/
├── utils/
│   ├── timeSync.js           // 时间同步与校准
│   └── scoreCalculator.js    // 计分算法
└── assets/
    └── skins/                // 主题皮肤（鼓面、特效）

```

---

### 交互细节设计

### 手势定义

- **准备姿势**：双手在胸前，手腕在检测区域内
- **击打判定**：
    - 检测手腕y坐标快速减小（向前运动）
    - 加速度阈值：Δy/Δt < -0.5（可调参数）
    - 速度矢量方向：主要向前，允许轻微左右偏移
- **防止误触**：击打后300ms内不再接受同一手输入

### 视觉特效

- **鼓面动画**：击打时鼓面缩放回弹，配合粒子效果
- **音符设计**：
    - 红音符（Don）：圆形，从右侧轨道下落
    - 蓝音符（Kat）：三角形，从左侧轨道下落
    - 大音符：需要双手同时击打
- **背景动画**：根据歌曲频谱生成动态背景